<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AEP Health Monitoring – Last 24 Hours</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="max-w-6xl mx-auto p-4">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-3xl font-bold">AEP Health Monitoring <span class="text-sm font-normal text-gray-400">– Last 24 Hours</span></h1>
      <div class="flex items-center space-x-2">
        <span id="statusBadge" class="bg-red-600 text-xs px-2 py-1 rounded">Disconnected</span>
        <button id="gearBtn" class="text-white text-xl focus:outline-none">⚙️</button>
      </div>
    </div>

    <div id="modal" class="hidden bg-gray-800 border border-gray-700 p-4 rounded mb-4">
      <p class="mb-2">Webhook URL:</p>
      <div class="flex items-center space-x-2">
        <code id="webhookUrl" class="text-blue-400 break-all"></code>
        <button id="copyBtn" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-2 py-1 rounded">Copy</button>
        <span id="copyStatus" class="text-green-400 text-xs hidden">Copied!</span>
      </div>
    </div>

    <div class="bg-gray-800 p-4 rounded shadow mb-6">
      <canvas id="barChart" height="100"></canvas>
    </div>

    <div class="bg-gray-800 p-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-2">Event Logs</h2>
      <div id="log" class="max-h-96 overflow-y-auto space-y-2"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('modal');
      const gearBtn = document.getElementById('gearBtn');
      const webhookUrl = document.getElementById('webhookUrl');
      const copyBtn = document.getElementById('copyBtn');
      const copyStatus = document.getElementById('copyStatus');
      const statusBadge = document.getElementById('statusBadge');
      webhookUrl.textContent = window.location.origin + "/webhook";

      gearBtn.addEventListener('click', () => {
        modal.classList.toggle('hidden');
        copyStatus.classList.add('hidden');
      });

      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(webhookUrl.textContent).then(() => {
          copyStatus.classList.remove('hidden');
          setTimeout(() => copyStatus.classList.add('hidden'), 2000);
        });
      });

      const ctx = document.getElementById('barChart').getContext('2d');
      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Array.from({length: 24}, (_, i) => `${i}:00`),
          datasets: [
            {
              label: 'Events',
              data: Array(24).fill(0),
              backgroundColor: 'rgb(59, 130, 246)'
            },
            {
              label: 'Errors',
              data: Array(24).fill(0),
              backgroundColor: 'rgb(239, 68, 68)'
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      async function fetchEvents() {
        try {
          const res = await fetch('/api/events');
          const data = await res.json();

          const perHourEvents = Array(24).fill(0);
          const perHourErrors = Array(24).fill(0);
          const logs = [];
          const nowTime = Date.now();
          let recentActivity = false;

          data.forEach(e => {
            const dt = new Date(e.timestamp);
            const hourDiff = Math.floor((nowTime - e.timestamp) / 3600000);
            if (hourDiff < 24) {
              const index = 23 - hourDiff;
              if (e.isError) {
                perHourErrors[index]++;
              } else {
                perHourEvents[index]++;
              }

              logs.push(\`
                <div class="p-2 border border-gray-700 rounded bg-gray-900">
                  <div class="flex justify-between items-center text-sm">
                    <span class="text-gray-400">\${dt.toLocaleString()}</span>
                    <span class="px-2 py-0.5 text-xs rounded \${e.isError ? 'bg-red-600' : 'bg-green-600'}">\${e.isError ? 'Error' : 'Event'}</span>
                  </div>
                  <pre class="text-xs whitespace-pre-wrap mt-1 text-gray-200">\${JSON.stringify(e.event, null, 2)}</pre>
                </div>
              \`);

              if (nowTime - e.timestamp < 2 * 60 * 1000) recentActivity = true;
            }
          });

          chart.data.datasets[0].data = perHourEvents;
          chart.data.datasets[1].data = perHourErrors;
          chart.update();

          document.getElementById('log').innerHTML = logs.reverse().join('');
          statusBadge.textContent = recentActivity ? 'Live' : 'Disconnected';
          statusBadge.className = recentActivity
            ? 'bg-green-600 text-xs px-2 py-1 rounded'
            : 'bg-red-600 text-xs px-2 py-1 rounded';
        } catch {
          statusBadge.textContent = 'Disconnected';
          statusBadge.className = 'bg-red-600 text-xs px-2 py-1 rounded';
        }
      }

      setInterval(fetchEvents, 5000);
      fetchEvents();
    });
  </script>
</body>
</html>
