<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Added viewport meta tag for proper responsive scaling on all devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AEP Health Monitoring – Last 24 Hours</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="max-w-6xl mx-auto p-4">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-3xl font-bold">AEP Health Monitoring <span class="text-sm font-normal text-gray-400">– Last 24 Hours</span></h1>
      <div class="flex items-center space-x-2">
        <span id="statusBadge" class="bg-red-600 text-xs px-2 py-1 rounded-md transition-colors duration-300">Disconnected</span>
        <button id="gearBtn" class="text-white text-xl focus:outline-none hover:text-gray-300">⚙️</button>
      </div>
    </div>

    <!-- Webhook URL Modal (Initially Hidden) -->
    <div id="modal" class="hidden bg-gray-800 border border-gray-700 p-4 rounded-lg mb-4">
      <p class="mb-2 font-semibold">Webhook URL:</p>
      <div class="flex items-center space-x-2">
        <code id="webhookUrl" class="text-blue-400 break-all bg-gray-900 p-2 rounded-md"></code>
        <button id="copyBtn" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-md font-semibold">Copy</button>
        <span id="copyStatus" class="text-green-400 text-xs hidden">Copied!</span>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="bg-gray-800 p-4 rounded-lg shadow mb-6">
      <canvas id="barChart" height="100"></canvas>
    </div>

    <!-- Event Logs Section -->
    <div class="bg-gray-800 p-4 rounded-lg shadow">
      <h2 class="text-lg font-semibold mb-2">Event Logs</h2>
      <div id="logContainer" class="max-h-96 overflow-y-auto space-y-2"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Element Caching ---
      const modal = document.getElementById('modal');
      const gearBtn = document.getElementById('gearBtn');
      const webhookUrlEl = document.getElementById('webhookUrl');
      const copyBtn = document.getElementById('copyBtn');
      const copyStatus = document.getElementById('copyStatus');
      const statusBadge = document.getElementById('statusBadge');
      const logContainer = document.getElementById('logContainer');
      const chartCanvas = document.getElementById('barChart');
      const displayedEventIds = new Set();

      // --- Initial Setup ---
      webhookUrlEl.textContent = window.location.origin + "/webhook";

      // --- Event Listeners ---
      gearBtn.addEventListener('click', () => {
        modal.classList.toggle('hidden');
        copyStatus.classList.add('hidden');
      });

      copyBtn.addEventListener('click', () => {
        const textToCopy = webhookUrlEl.textContent;
        const textArea = document.createElement('textarea');
        textArea.value = textToCopy;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          copyStatus.classList.remove('hidden');
          setTimeout(() => copyStatus.classList.add('hidden'), 2000);
        } catch (err) {
          console.error('Failed to copy text: ', err);
        }
        document.body.removeChild(textArea);
      });

      // --- Chart.js Initialization ---
      const ctx = chartCanvas.getContext('2d');
      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Array.from({ length: 24 }, (_, i) => {
            const date = new Date();
            date.setHours(date.getHours() - (23 - i));
            return `${date.getHours()}:00`;
          }),
          datasets: [
            {
              label: 'Events',
              data: Array(24).fill(0),
              backgroundColor: 'rgba(59, 130, 246, 0.7)',
              borderColor: 'rgb(59, 130, 246)',
              borderWidth: 1,
            },
            {
              label: 'Errors',
              data: Array(24).fill(0),
              backgroundColor: 'rgba(239, 68, 68, 0.7)',
              borderColor: 'rgb(239, 68, 68)',
              borderWidth: 1,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { 
              beginAtZero: true,
              ticks: { color: '#9CA3AF' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            x: {
              ticks: { color: '#9CA3AF' },
              grid: { display: false }
            }
          },
          plugins: {
            legend: {
              labels: { color: '#E5E7EB' }
            }
          }
        }
      });

      /**
       * Updates the status badge with the given text and style.
       */
      const updateStatusBadge = (state) => {
        if (state === 'live') {
          statusBadge.textContent = 'Live';
          statusBadge.className = 'bg-green-600 text-xs px-2 py-1 rounded-md transition-colors duration-300';
        } else {
          statusBadge.textContent = 'Disconnected';
          statusBadge.className = 'bg-red-600 text-xs px-2 py-1 rounded-md transition-colors duration-300';
        }
      };

      /**
       * Creates a collapsible log entry element.
       */
      const createLogElement = (e) => {
        const dt = new Date(e.timestamp);
        const isError = e.isError;

        const detailsEl = document.createElement('details');
        detailsEl.className = 'border border-gray-700 rounded-lg bg-gray-900 animate-fade-in';

        const summaryEl = document.createElement('summary');
        summaryEl.className = 'flex flex-col';

        // Header: timestamp + badge
        const headerLine = document.createElement('div');
        headerLine.className = 'flex justify-between items-center text-sm';

        const timeSpan = document.createElement('span');
        timeSpan.className = 'text-gray-400';
        timeSpan.textContent = dt.toLocaleString();
        headerLine.appendChild(timeSpan);

        const statusSpan = document.createElement('span');
        const statusColor = isError ? 'bg-red-600' : 'bg-blue-600';
        statusSpan.className = `px-2 py-0.5 text-xs rounded-md ${statusColor}`;
        statusSpan.textContent = isError ? 'Error' : 'Event';
        headerLine.appendChild(statusSpan);

        summaryEl.appendChild(headerLine);

        // If it's an error, list each error code/message
        if (isError && e.event.metrics?.statusSummary?.errors) {
          e.event.metrics.statusSummary.errors.forEach(err => {
            const errLine = document.createElement('div');
            errLine.className = 'text-gray-200 text-xs mt-1';
            errLine.textContent = `${err.code}: ${err.message}`;
            summaryEl.appendChild(errLine);
          });
        }

        detailsEl.appendChild(summaryEl);

        // Full JSON payload in the expanded panel
        const pre = document.createElement('pre');
        pre.className = 'text-xs whitespace-pre-wrap p-2 text-gray-200 border-t border-gray-700';
        pre.textContent = JSON.stringify(e.event, null, 2);
        detailsEl.appendChild(pre);

        return detailsEl;
      };

      // --- Fetch & Render Loop ---
      async function fetchEvents() {
        try {
          const res = await fetch('/api/events');
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const data = await res.json();

          const perHourEvents = Array(24).fill(0);
          const perHourErrors = Array(24).fill(0);
          const nowTime = Date.now();
          let recentActivity = false;
          const newLogs = [];

          data.forEach(e => {
            const eventId = e.id || e.timestamp;
            const hourDiff = Math.floor((nowTime - e.timestamp) / 3600000);
            if (hourDiff < 24) {
              const idx = 23 - hourDiff;
              e.isError ? perHourErrors[idx]++ : perHourEvents[idx]++;
              if (!displayedEventIds.has(eventId)) {
                newLogs.push(e);
                displayedEventIds.add(eventId);
              }
            }
            if (nowTime - e.timestamp < 2 * 60 * 1000) recentActivity = true;
          });

          newLogs.reverse().forEach(logData => {
            logContainer.prepend(createLogElement(logData));
          });

          // Keep max 200 logs
          while (logContainer.children.length > 200) {
            logContainer.removeChild(logContainer.lastChild);
          }

          chart.data.datasets[0].data = perHourEvents;
          chart.data.datasets[1].data = perHourErrors;
          chart.update('none');

          updateStatusBadge(recentActivity ? 'live' : 'disconnected');
        } catch (error) {
          console.error("Failed to fetch or process events:", error);
          updateStatusBadge('disconnected');
        }
      }

      fetchEvents();
      setInterval(fetchEvents, 5000);
    });
  </script>

  <!-- CSS animation + accordion arrows -->
  <style>
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.5s ease-out forwards;
    }

    /* Custom accordion arrows */
    details summary {
      list-style: none;
      cursor: pointer;
      padding: 0.5rem;
    }
    details summary::-webkit-details-marker,
    details summary::marker {
      display: none;
    }
    details summary::before {
      content: '▶';
      display: inline-block;
      width: 1em;
      margin-right: 0.5em;
      transform: rotate(0deg);
      transition: transform 0.2s ease;
    }
    details[open] summary::before {
      content: '▼';
    }
  </style>
</body>
</html>
